<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('[SW] Registered'))
      .catch(err => console.error('[SW] Failed', err));
  }

  let notificationEnabled = false;

  function requestNotificationPermission() {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        notificationEnabled = true;
        alert("Notifications enabled!");
      } else {
        alert("Please enable notifications to receive alerts.");
      }
    });
  }

  const eventWindows = [
    { start: "09:30", end: "10:30", name: "ENGLISH TE 1 ⏳09:30AM - 10:30AM KST" },
    { start: "12:45", end: "13:45", name: "KOREAN/JAPANESE/VIETNAMESE TE 1 ⏳12:45PM - 01:45PM KST" },
    { start: "13:45", end: "14:45", name: "CHINESE TE 1 ⏳01:45PM - 02:45PM KST" },
    { start: "18:30", end: "19:30", name: "KOREAN/JAPANESE/VIETNAMESE TE 2 ⏳06:30PM - 07:30PM KST" },
    { start: "19:30", end: "20:30", name: "CHINESE TE 2 ⏳07:30PM - 08:30PM KST" },
    { start: "22:50", end: "23:50", name: "ENGLISH TE 2 ⏳10:50PM - 11:50PM KST" }
  ];

  const notifiedToday = new Set();

  function getKSTNow() {
    const now = new Date();
    return new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  }

  function checkEvents() {
    const today = new Date().toISOString().split('T')[0];
    const kstNow = getKSTNow();
    const hhmm = kstNow.getHours().toString().padStart(2, '0') + ':' + kstNow.getMinutes().toString().padStart(2, '0');

    for (const event of eventWindows) {
      if (hhmm >= event.start && hhmm < event.end) {
        const key = today + event.start;
        if (!notifiedToday.has(key)) {
          notifiedToday.add(key);
          if (Notification.permission === 'granted') {
            navigator.serviceWorker.getRegistration().then(reg => {
              if (reg) {
                reg.showNotification("⏰ Time Event Reminder (KST)", {
                  body: `${event.name}`,
                  icon: 'https://cdn-icons-png.flaticon.com/512/1827/1827392.png',
                  vibrate: [200, 100, 200],
                  tag: 'te-reminder',
                  requireInteraction: false
                });
              }
            });
          }
        }
        break;
      }
    }
  }

  // Check every minute
  setInterval(checkEvents, 60000);
  checkEvents(); // first call
</script>
